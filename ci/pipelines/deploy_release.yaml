resources:
  - name: gh-release
    type: github-release
    source:
      user: coreos-inc
      repository: apostille
      access_token: {{quay-github-token}}
  - name: quay-policies
    type: git
    source:
      uri: git@github.com:coreos-inc/quay-policies.git
      branch: master
      private_key: {{quay-policies-git-private-key}}
  - name: apostille-code
    type: git
    source:
      uri: git@github.com:coreos-inc/apostille.git
      branch: master
      private_key: {{quay-git-private-key}}
      disable_ci_skip: true
  - name: apostille-build-util
    type: docker-image
    source:
      repository: quay.io/quay/apostille-build-util
      username: {{quay-robot-username}}
      password: {{quay-robot-password}}

jobs:
  - name: deploy_release
    max_in_flight: 1
    plan:
      - get: gh-release
        trigger: true
      - get: quay-policies
      - get: apostille-code
      - get: apostille-build-util
      - task: deploy_release
        image: apostille-build-util
        file: apostille-code/ci/tasks/deploy_release.yaml
        params: {KUBE_CTL_CONFIG: {{kubectl-config}}, QUAY_APP_USERNAME: {{quay-app-username}}, QUAY_APP_PASSWORD: {{quay-app-password}} }